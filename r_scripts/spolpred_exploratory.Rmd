---
title: "Spoligotypes exploratory"
output: html_document
---

```{r setup, include=FALSE, echo = F, warning=F, message=F}

# SETUP ----

rm(list = ls())

knitr::opts_chunk$set(echo = F)
# options(scipen=1, digits=2)
options(scipen=999, digits = 3)
table_font_sz <- 8

```

```{r library, include=FALSE, echo = F, warning=F, message=F}

library(sjmisc)
library(dplyr)
library(tibble)
library(stringr)

```

```{r functions, echo = F, warning=F, message=F}

source("https://raw.githubusercontent.com/GaryNapier/Packages_functions/master/Functions.R")

expand_hierarchy <- function(df, group_by_col_name, hierarchy_to_expand_col_name){
  # Takes df like this:
  #   ID      Group
  # 1 samp_1  4.2.1.1
  # 2 samp_2  1.2.1.2.1
  
  # And makes this:
  #   ID    lin_level_1 lin_level_2 lin_level_3 lin_level_4 lin_level_5   max_lin
  # 1 samp_1          4         4.2       4.2.1     4.2.1.1        <NA>   4.2.1.1
  # 2 samp_2          1         1.2       1.2.1     1.2.1.2   1.2.1.2.1 1.2.1.2.1
  
  split_lins <- stringr::str_split(df[[hierarchy_to_expand_col_name]], "\\.")
  max_lin_len <- max(sapply(split_lins, length))
  mat <- matrix(nrow = length(df[[group_by_col_name]]), ncol = max_lin_len+1)
  mat[, 1] <- df[[group_by_col_name]]
  for(i in 1:nrow(mat)){
    for(lin_level in 1:max_lin_len){
      
      len_lin <- length(split_lins[[i]])
      
      if(lin_level > len_lin){
        mat[i, lin_level+1] <- NA
      }else{
        mat[i, lin_level+1] <- paste0(split_lins[[i]][1:lin_level], collapse = ".")
      }
    }
  }
  
  max_lin <- vector()
  for(i in seq(nrow(mat))){
    max_lin[i] <- mat[i, which.max(sapply(mat[i, -1], len_str))+1]
  }
  mat <- data.frame(cbind(mat, max_lin), stringsAsFactors = F)
  names(mat) <- c("id", paste0("lin_level_", 1:(ncol(mat)-2) ), "max_lin")
  return(mat)
}


top_spol_freq <- function(x, col){
  x %>% 
    group_by_(.dots = lazyeval::lazy(col)) %>% 
    count(.dots = lazyeval::lazy(col), spoligotype) %>% 
    arrange(desc(n), .by_group = TRUE) %>%
    top_n(10, n) %>% 
    data.frame()
}

```


```{r variables, echo = F, warning=F, message=F}


```

```{r paths, echo = F, warning=F, message=F}

setwd("~/Documents/spolpred/r_scripts/")

data_path <- "../data/"

```

#### Data file
```{r files, echo = T, warning=F, message=F}

spoligo_lineage_full_file <- paste0(data_path, "spoligo_lineage.full.txt")

```

```{r read-in-data, echo = T, warning=F, message=F}

spoligo_lineage_full <- read.table(spoligo_lineage_full_file, header = T, sep = "\t", 
                                   colClasses = c("spoligotype" = "character"))

```

```{r clean-data, echo = F, warning=F, message=F}

# Remove "lineage"
spoligo_lineage_full$lineage <- gsub("lineage", "", spoligo_lineage_full$lineage)

# Remove and store animal strains
animal <- subset(spoligo_lineage_full, grepl("M", lineage))
spoligo_lineage_full <- subset(spoligo_lineage_full, !(grepl("M", lineage)))

# Expand lineages and merge
exp <- expand_hierarchy(spoligo_lineage_full, "sample", "lineage")
data <- merge(rbind(spoligo_lineage_full, animal), exp,
                              by.x = "sample", by.y = "id", all.x = T, 
                              sort = F)

data$lin_level_1 <- ifelse(grepl("M", data$lineage), data$lineage, data$lin_level_1)
data$max_lin <- ifelse(grepl("M", data$lineage), data$lineage, data$max_lin)

# Remove 0000000000000000000000000000000000000000000 ? 
data <- subset(data, !(spoligotype == "0000000000000000000000000000000000000000000"))

# Remove everything except lin and spoligotype info
data <- dplyr::select(data, sample:lineage, lin_level_1:max_lin)

# Keep only those with 5 or more samples per spoligo
data <- data %>% group_by(spoligotype) %>% filter(n() > 4) %>% data.frame()

```

### Basic stats

```{r basic-stats, echo = T, warning=F}

head(data)
nrow(data)
length(unique(data$spoligotype))
length(unique(data$lineage))

```

Lineage frequencies

```{r n-spol-lin, echo = T, warning=F}

table(data$lineage) %>% as.data.frame() %>% arrange(Var1)
table(data$lin_level_1) %>% as.data.frame() %>% arrange(Var1)
table(data$lin_level_2) %>% as.data.frame() %>% arrange(Var1)
table(data$lin_level_3) %>% as.data.frame() %>% arrange(Var1)
table(data$lin_level_4) %>% as.data.frame() %>% arrange(Var1)
table(data$lin_level_5) %>% as.data.frame() %>% arrange(Var1)

```

Top ten spoligotypes per lineage, per level

```{r top-spol-lin, echo = T, warning=F}

top_spol_freq(data, lin_level_1)
top_spol_freq(data, lin_level_2)
top_spol_freq(data, lin_level_3)
top_spol_freq(data, lin_level_4)

```

Top ten most frequent spoligotypes and their lineages (per level)

```{r top-ten-spol-tables, echo = T, warning=F}

top_spol <- table(data$spoligotype) %>% as.data.frame() %>% arrange(desc(Freq)) %>% top_n(10, Freq)
top_spol_sub <- subset(data, spoligotype %in% top_spol$Var1)

table(top_spol_sub$spoligotype, top_spol_sub$lineage)
table(top_spol_sub$spoligotype, top_spol_sub$lin_level_1)
table(top_spol_sub$spoligotype, top_spol_sub$lin_level_2)
table(top_spol_sub$spoligotype, top_spol_sub$lin_level_3)
table(top_spol_sub$spoligotype, top_spol_sub$lin_level_4)

```

### Count how many spoligotypes are in more than 1 lineage etc

```{r spol-counts, echo = F, warning = F}

lv1Summary <- data %>% count(spoligotype, lin_level_1)
lv2Summary <- data %>% count(spoligotype, lin_level_2)
lv3Summary <- data %>% count(spoligotype, lin_level_3)
lv4Summary <- data %>% count(spoligotype, lin_level_4)
lv5Summary <- data %>% count(spoligotype, lin_level_5)

SpoligoMultiLv1Lineage <- lv1Summary %>% group_by(spoligotype) %>% filter(n()>1)
SpoligoMultiLv2Lineage <- lv2Summary %>% group_by(spoligotype) %>% filter(n()>1)
SpoligoMultiLv3Lineage <- lv3Summary %>% group_by(spoligotype) %>% filter(n()>1)
SpoligoMultiLv4Lineage <- lv4Summary %>% group_by(spoligotype) %>% filter(n()>1)
SpoligoMultiLv5Lineage <- lv5Summary %>% group_by(spoligotype) %>% filter(n()>1)

# in more than 2 lineages
SpoligoMultiLv1Lineage2 <- lv1Summary %>% group_by(spoligotype) %>% filter(n()>2)
SpoligoMultiLv2Lineage2 <- lv2Summary %>% group_by(spoligotype) %>% filter(n()>2)
SpoligoMultiLv3Lineage2 <- lv3Summary %>% group_by(spoligotype) %>% filter(n()>2)
SpoligoMultiLv4Lineage2 <- lv4Summary %>% group_by(spoligotype) %>% filter(n()>2)
SpoligoMultiLv5Lineage2 <- lv5Summary %>% group_by(spoligotype) %>% filter(n()>2)

# in more than 3 lineages
SpoligoMultiLv1Lineage3 <- lv1Summary %>% group_by(spoligotype) %>% filter(n()>3)
SpoligoMultiLv2Lineage3 <- lv2Summary %>% group_by(spoligotype) %>% filter(n()>3)
SpoligoMultiLv3Lineage3 <- lv3Summary %>% group_by(spoligotype) %>% filter(n()>3)
SpoligoMultiLv4Lineage3 <- lv4Summary %>% group_by(spoligotype) %>% filter(n()>3)
SpoligoMultiLv5Lineage3 <- lv5Summary %>% group_by(spoligotype) %>% filter(n()>3)

# in more than 4 lineages
SpoligoMultiLv1Lineage4 <- lv1Summary %>% group_by(spoligotype) %>% filter(n()>4)
SpoligoMultiLv2Lineage4 <- lv2Summary %>% group_by(spoligotype) %>% filter(n()>4)
SpoligoMultiLv3Lineage4 <- lv3Summary %>% group_by(spoligotype) %>% filter(n()>4)
SpoligoMultiLv4Lineage4 <- lv4Summary %>% group_by(spoligotype) %>% filter(n()>4)
SpoligoMultiLv5Lineage4 <- lv5Summary %>% group_by(spoligotype) %>% filter(n()>4)

```

```{r spol-lineage-matching, echo = F, warning = F}

# Show consistency with the lineage scheme. Things that would be good to report are
# Number of spoligotypes per sublineage
# Identify spoligotypes that cut across multiple sublineages (i.e. have poor resulution)
# Identify sublineages that have multiple spoligotypes (i.e. better resolution using spoligotyping)

```

```{r plots, echo = T, warning=F}


# rf_fit <- train(as.factor(old) ~ ., 
#                 data = abalone_train, 
#                 method = "ranger")
# 
# library(caret)
# 
# rf_fit <- train(lin_level_1 ~ spoligotype, 
#                 data = data, 
#                 method = "ranger")
# 
# rf_fit
# 
# confusionMatrix(rf_fit, as.factor(data$spoligotype))
# 

dummy_file <- paste0(data_path, "dummy_data.csv")

dummy <- read.csv(dummy_file)

dummy

rf_fit <- train(lineage ~ spol, 
                data = dummy, 
                method = "ranger")

rf_pred <- predict(rf_fit, dummy)

caret::confusionMatrix(rf_pred, as.factor(dummy$lineage))







```











